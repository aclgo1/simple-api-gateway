<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Pass</title>
    <style>
        * {
    background-color: white;
    padding: 0;
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
}

#pass {
    justify-content: center;
    align-items: center;
    text-align: center;
}

h3{
    text-align: center;
    margin-top: 5rem;
    color: rgb(16, 216, 149);
}

#pass ul {
    text-align: center;
    list-style-type: none;
    position: relative;
    padding: 0;
    margin: 0;

}

li {
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    display: flex;
}

#new-pass, #confirm-pass {
    text-align: center;
    width: 400px;
    height: 30px;
    border-radius: 30px;
}

label{
    color: cadetblue;
    font-weight: bold;
    text-align: right;
    margin-right: 10px;
}

#message {
    color: rgb(177, 19, 19);
    font-weight: bold;
    display: none;
}

button{
    color: cadetblue;
    width: 200px;
    height: 30px;
    font-weight: bold;
    border-radius: 10px;
    border-style:double;
    background-color: rgb(40, 121, 94);
}

button:hover{
    color: rgb(85, 223, 228);
}

input[type="text"]{
    box-sizing: border-box;
}
    </style>
    <body>
    <div>
        <h3>Renew Your Password</h3>
    </div>

    <div id="pass">
        <form id="renew-form">
            <ul>
                <li>
                    <label for="new-pass">Password</label>
                    <input type="password" name="new-pass" id="new-pass" required />
                </li>
                <li>
                    <label for="confirm-pass">Confirm Password</label>
                    <input type="password" name="confirm-pass" id="confirm-pass" required />
                </li>
                <li>
                    <label for="input-captcha">Captcha Code</label>
                    <img id="image-captcha" alt="Captcha Image">
                    <input type="text" id="input-captcha" placeholder="Enter captcha code" required>
                </li>
                <li>
                    <button type="submit" id="new-btn">Renew</button>
                </li>
                <li id="message"></li>
            </ul>
        </form>
    </div>
</body>

<script>

getCaptcha();
let idCaptcha = ""
let inputCaptcha = document.getElementById("input-captcha");

const send = document.getElementById("new-btn");
send.onclick = function(e){
    e.preventDefault();
    SendNewPass();
};

function SendNewPass(){

    const search = new URLSearchParams(window.location.search);
    const ccode = search.get("code")
    const newPass = document.getElementById("new-pass").value;
    const confirmPass = document.getElementById("confirm-pass").value;

    if (ccode === ""){
        mError("invalid link renew pass");
        return;  
    }

    if (newPass === "" || newPass.length < 6 || confirmPass === ""){
        mError("invalid passwords input");
        return;
    }

    if (inputCaptcha.value == ""){
        window.alert("captcha code empty")
        return;
    }

    const data = {
        new_pass: newPass,
        confirm_pass: confirmPass,
        captcha_id: idCaptcha,
        captcha_awnser: inputCaptcha.value,
    }

    send.disabled = true
    send.innerHTML = `wait...`

    const options = {
        method:"POST",
        body: JSON.stringify(data),
        headers: {
            'Content-Type':'application/json',
        },
    }

    fetch("/api/user/newpass/"+ccode, options)
    .then(response =>{
        return response.json();
    })
    .then(data =>{
        if (data.error){
            console.log(data.error);
            mError(data.error);
            getCaptcha();
            return;
        }

        mError(data.message);
    })
    .finally(()=>{
        send.disabled = false
        send.innerHTML = `Renew`
    });
}

function mError(msg){
    const message = document.getElementById("message");
    message.display = "block"
    message.textContent = msg
};

function getCaptcha(){
    opt = {
        method:'GET',
        headers: {
            'Content-Type':'application/json',
        }
    }

    fetch("/api/captcha", opt)
    .then(response => {
        return response.json()
    })
    .then(data =>{
        const imageCaptcha = document.getElementById("image-captcha")
        imageCaptcha.src = data.base64_image;
        // const imageCaptchaSignup = document.getElementById("image-captcha-signup")
        // imageCaptchaSignup.src = data.base64_image;

        idCaptcha = data.id;
        inputCaptcha.value = "";
        
        console.log(idCaptcha);
    })
    .catch(error=>{
        console.log(`error in connection ${error.message}`)
    })
}
</script>
</html>