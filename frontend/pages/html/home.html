<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"  type="text/css">
    <title>Home</title>
</head>
<style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }

        /* Navbar */
        .navbar { background: white; border-bottom: 1px solid #e2e8f0; padding: 15px 0; position: sticky; top: 0; z-index: 100; }
        .nav-content { display: flex; justify-content: space-between; align-items: center; }
        .nav-buttons { display: flex; gap: 10px; }
        
        .nav-btn { 
            padding: 8px 16px; border-radius: 6px; border: 1px solid #e2e8f0; 
            background: white; cursor: pointer; font-weight: 500; transition: 0.2s;
        }
        .nav-btn:hover { background: #f1f5f9; }
        #logout { color: var(--danger); border-color: #fee2e2; }

        /* Classes Utilit√°rias */
        .hidden { display: none !important; }

        /* Se√ß√µes de Informa√ß√£o (Perfil e Pedidos) */
        .info-panel {
            margin: 20px 0; padding: 20px; border-radius: 12px;
            box-shadow: var(--shadow); border-left: 5px solid var(--primary);
            background: white;
        }
        
        #orders-info { border-left-color: var(--success); background: #f0fdf4; }
        .panel-title { margin-top: 0; display: flex; align-items: center; gap: 10px; }

        /* Itens da Lista de Pedidos */
        .order-item {
            background: white; padding: 15px; margin-bottom: 10px;
            border-radius: 8px; border: 1px solid #dcfce7;
            display: flex; justify-content: space-between; align-items: center;
        }
        .order-item strong { color: #166534; }
        .order-date { font-size: 0.85rem; color: #64748b; }

        /* Grid de Produtos Principal */
        .grid-products { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .product-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); }
        .btn-buy { width: 100%; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 15px; }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        /* Blocos Individuais de Informa√ß√£o */
        .profile-field {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 10px;
        }

        .profile-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-value {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 500;
        }

        /* Badge de Status/Role */
        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            background: #e0e7ff;
            color: #4338ca;
            font-size: 0.8rem;
        }

        /* Rodap√© do Perfil (Datas e Bot√£o) */
        .profile-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #f1f5f9;
        }

        .date-group {
            font-size: 0.75rem;
            color: #94a3b8;
        }

    .order-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 15px;
        transition: transform 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .order-details h4 {
        margin: 0 0 5px 0;
        color: var(--primary);
    }

    .order-details p {
        margin: 2px 0;
        font-size: 0.9rem;
        color: #475569;
    }

    .order-price {
        font-weight: bold;
        color: var(--success);
        font-size: 1.1rem;
        background: #f0fdf4;
        padding: 5px 10px;
        border-radius: 4px;
    }

    .order-meta {
        font-size: 0.75rem;
        color: #94a3b8;
        margin-top: 8px;
    }

    </style>
<body>
<header class="navbar">
        <div class="container nav-content">
            <h1 style="color: var(--primary); margin:0;">Aclgo<span>Brand</span></h1>
            <nav class="nav-buttons">
                <button id="you-balance" class="nav-btn"></button>
                <button id="profile" class="nav-btn">üë§ Profile</button>
                <button id="show-orders" class="nav-btn">üì¶ You Orders</button>
                <button id="add-balance" class="nav-btn">Add Balance</button>
                <button id="logout" class="nav-btn">Logout</button>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="profile-info" class="info-panel hidden"></div>

        <div id="orders-info" class="info-panel hidden">
            <h3 class="panel-title">üì¶ You Orders</h3>
            <div id="orders-list">

            </div>
        </div>
        <div id="balance-info" class="info-panel hidden">

        </div>
        <h2 style="margin-top: 30px;">Products</h2>
        <div id="list-products" class="grid-products"></div>
    </main>
</body>
<script>

const BASE_API_ENDPOINT = "http://localhost:4000"

let access_token = window.localStorage.getItem("access_token");
let refresh_token = window.localStorage.getItem("refresh_token");
const logout = document.getElementById("logout");
const profile = document.getElementById("profile")
const userBalance = document.getElementById("you-balance")
const addBalanceBtn = document.getElementById("add-balance")
const updateUserBtn = document.getElementById("btn-user-update")
const btnOrders = document.getElementById("show-orders");
let currentUserId = "";
let currentUserName = "";
let currentUserLastname = ""
let currentUserEmail = ""
let isRefreshing = false;
let refreshSubscribers = [];


// CheckTokenExist();
getBalanceInfo();

logout.addEventListener('click', (e) => {
    e.preventDefault(); 
    Logout();
})

addBalanceBtn.addEventListener('click', (e)=>{
    e.preventDefault();

    const infoDiv = document.getElementById("balance-info")

    infoDiv.classList.toggle("hidden")
    if(!infoDiv.classList.contains("hidden")){
        infoDiv.innerHTML = `
        <h3 class="panel-title">Add Balance</h3>
        <form id="form-add-balance" style="display: flex; flex-direction: column; gap: 10px;">
            <label>Amount:
                <input type="number" step="any" id="amount-add-balance" value="" class="nav-btn" style="width: 80%">
            </label>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="submit" class="nav-btn" style="background: var(--success); color: white;">Generate Payment</button>
                <button type="button" id="cancel-add-balance" class="nav-btn">Cancel</button>
            </div>
        </form>
    `
    document.getElementById("cancel-add-balance").onclick = (e)=>{
        e.preventDefault();
        infoDiv.innerHTML = ``
        infoDiv.classList.add("hidden")
    }

    document.getElementById("form-add-balance").onsubmit = (ev) =>{
        ev.preventDefault();
        const amount = parseFloat(document.getElementById("amount-add-balance").value)
        if(isNaN(amount) || amount <= 0){
            alert("please enter valid amount")
            return
        }

        addBalance(amount, infoDiv);
    }

    }
})

profile.addEventListener('click', (e) => {
    e.preventDefault();
    const infoDiv = document.getElementById("profile-info");

    // Alterna a classe hidden
    infoDiv.classList.toggle("hidden");

    // Se a div foi mostrada (N√ÉO tem a classe hidden), chama a fun√ß√£o Profile
    if (!infoDiv.classList.contains("hidden")) {
        infoDiv.innerHTML = "<p>Carregando perfil...</p>";
        Profile();
    }
});
        
btnOrders.addEventListener('click', (e) => {
    e.preventDefault();
    const ordersPanel = document.getElementById("orders-info");
    
    // Toggle de visibilidade
    ordersPanel.classList.toggle("hidden");
    // Se abrir, busca os dados
    if (!ordersPanel.classList.contains("hidden")) {
        document.getElementById('orders-list').innerHTML = "<p>Carregando seus pedidos...</p>";
        getOrdersProducts(currentUserId);
    }
});



function subscribeTokenRefresh(cb){
    refreshSubscribers.push(cb);
}

function onTokenRefreshed(){
    refreshSubscribers.forEach(cb => cb());
    refreshSubscribers = [];
}

function updateUserForm(e){
    if (e) e.preventDefault();

    const profInfo = document.getElementById("profile-info")

    profInfo.innerHTML = `
        <h3 class="panel-title">Update Profile</h3>
        <form id="form-update-user" style="display: flex; flex-direction: column; gap: 10px;">
            <label>Name:
                <input type="text" id="update-name" value="${currentUserName}" class="nav-btn" style="width: 100%">
            </label>
            <label>Lastname:
                <input type="text" id="update-lastname" value="${currentUserLastname}" class="nav-btn" style="width: 100%">
            </label>
            <label>Email:
                <input type="text" id="update-email" value="${currentUserEmail}" class="nav-btn" style="width: 100%">
            </label>
            <label>Password:
                <input type="text" id="update-password" value="" class="nav-btn" style="width: 100%">
            </label>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="submit" id="btn-update-profile-submit" class="nav-btn" style="background: var(--success); color: white;">Save Changes</button>
                <button type="button" id="cancel-update" class="nav-btn">Cancel</button>
            </div>
        </form>
    `
    document.getElementById("cancel-update").onclick =()=> Profile();
    document.getElementById("form-update-user").onsubmit = (ev) => {
        ev.preventDefault();
        if(!confirm("tem certeza que deseja atualizar as informacoes do usuario?")) return;

        const btnSubmit = document.getElementById("btn-update-profile-submit")

        if(btnSubmit){
            btnSubmit.disabled = true;
            btnSubmit.innerText = `updating...`
        }

        const name = document.getElementById("update-name").value
        const lastname = document.getElementById("update-lastname").value
        const email = document.getElementById("update-email").value
        const password = document.getElementById("update-password").value

        const data = {
            user_id:currentUserId,
            name:name,
            lastname:lastname,
            email:email,
            password:password,
        }

        if (password.length > 0 && password.length < 6) {
            alert("password caracters invalid")
            return;
        } 

        updateUser(data);

        btnSubmit.innerText = `Save Changes`
        btnSubmit.disabled = false;

        Profile();

    }
}

// function CheckTokenExist(){

//     opt = {
//         method: "GET",
//         headers: {
//             'Content-Type':'application/json',
//             'access-token' :`bearer ${access_token}`,
//         }
//     }

//     fetch(BASE_API_ENDPOINT + "/api/valid_token", opt)
//     .then(response => {
//         if(response.status == 401){
//             return refreshTokens(()=>CheckTokenExist())
//         }
//         if(!response.ok){
//             console.log("unauthorized")
//             window.location.assign("/unauthorized")
//             return;
//         }

//         // Profile();
//         getProducts();
//     })

// };

function refreshTokens(fn){
    
    if(isRefreshing){
        return new Promise(resolve =>{
            subscribeTokenRefresh(()=>{
                resolve(fn());
            })
        })
    }

    isRefreshing = true;

    const opt = {
        method: "GET",
        headers: {
            'Content-Type':'application/json',
            'access-token' :`bearer ${access_token}`,
            'refresh-token': `bearer ${refresh_token}`
        }
    }

    fetch(BASE_API_ENDPOINT + "/api/refresh", opt)
    .then(response => {
        if(!response.ok){
            console.log("unauthorized")
            window.location.assign("/unauthorized")
            return;
        }

        return response.json()
    })

    .then(data =>{
        access_token = data.tokens.access_token;
        refresh_token = data.tokens.refresh_token;

        // localStorage.clear();

        window.localStorage.setItem("access_token", access_token)
        window.localStorage.setItem("refresh_token", refresh_token)

        console.log("tokens access and refresh new")
        onTokenRefreshed();
        return fn()
    })
    .catch(error =>{
        console.error("error in refresh:", error)
        window.location.assign("/unauthorized")
    })
    .finally(
        isRefreshing = false
    )  
}


function Logout() {
    opt = {
        method: "GET",
        headers: {
            'Content-Type':'application/json',
            'access-token' :`Bearer ${access_token}`,
            'refresh-token' : `Bearer ${refresh_token}`
        }
    }

    fetch(BASE_API_ENDPOINT + "/api/logout", opt)
    .then(response => {
        if(!response.ok){
            console.log("unauthorized")
            window.location.assign("/unauthorized")
            return;
        }
        return response.json();
    })

    .then(r => {
        const divProfile = document.getElementById('profile');
        divProfile.innerHTML = ``

        console.log(r.message)
        access_token = "";
        refresh_token = "";

        // const log = document.getElementById('logout');
        window.location.assign("/login")  
    });
}

function getBalanceInfo() {
    opt = {
        method: "GET",
        headers: {
            'Content-Type':'application/json',
            'access-token' :`bearer ${access_token}`,
        }
    }

    let userId = ""

    fetch(BASE_API_ENDPOINT + "/api/user/find", opt)
    .then(response => {

        if(response.status == 401){
            return refreshTokens(()=> getBalanceInfo());
        }
        
        if (!response.ok) {
            console.log("error to get user info")
            throw new Error("error to get user info")
        }

        return response.json();
    })
    .then(data => {
        if(!data || !data.user) return;
        currentUserId = data.user.user_id;
        userId = data.user.user_id;
        userBalance.innerHTML = `Balance: R$ ${data.user.balance.toFixed(2)}`
    })
    .catch(error=>{
        console.log(error)
    })
}

function Profile() {
    console.log("console loaded")
    opt = {
        method: "GET",
        headers: {
            'Content-Type':'application/json',
            'access-token' :`bearer ${access_token}`,
        }
    }

    let userId = ""

    fetch(BASE_API_ENDPOINT + "/api/user/find", opt)
    .then(response => {

        if(response.status == 401){
            return refreshTokens(()=>Profile());
        }
        
        if (!response.ok) {
            console.log("error to get user info")
            throw new Error("error to get user info")
        }

        return response.json();
    })
    .then(data => {
        userId = data.user.user_id;
        currentUserId = data.user.user_id;
        currentUserName = data.user.name;
        currentUserLastname = data.user.lastname
        currentUserEmail = data.user.email
        userBalance.innerHTML = `Balance: R$ ${data.user.balance.toFixed(2)}`
        const divProfile = document.getElementById('profile-info')

        divProfile.innerHTML = `
            <h3 class="panel-title">User Profile</h3>

            <div class="profile-grid">
                <div class="profile-field">
                    <span class="profile-label">Full Name</span>
                    <span class="profile-value">${data.user.name} ${data.user.lastname}</span>
                </div>
                
                <div class="profile-field">
                    <span class="profile-label">Email Address</span>
                    <span class="profile-value">${data.user.email}</span>
                </div>

                <div class="profile-field">
                    <span class="profile-label">Current Balance</span>
                    <span class="profile-value" style="color: var(--success)">R$ ${data.user.balance.toFixed(2)}</span>
                </div>

                <div class="profile-field">
                    <span class="profile-label">Account Role</span>
                    <span class="profile-value">
                        <span class="role-badge">${data.user.role}</span>
                    </span>
                </div>
            </div>

            <div class="profile-footer">
                <div class="date-group">
                    <div>Created: ${new Date(data.user.created_at).toLocaleDateString('pt-BR')}</div>
                    <div>Last Update: ${new Date(data.user.updated_at).toLocaleDateString('pt-BR')}</div>
                </div>
                <button id="btn-user-update" class="nav-btn" style="background: var(--primary); color: white; border: none; padding: 10px 20px;">
                    Edit Profile
                </button>
            </div>
        `;
        document.getElementById("btn-user-update").onclick = updateUserForm

        // getOrdersProducts(data.user.user_id);
    })
}

function getProducts(){
    opt = {
        method: 'GET',
        headers: {
            'Content-Type':'application/json'
        }
    }

    fetch(BASE_API_ENDPOINT + '/api/product/findall', opt)
    .then(response => {
        if(response.status == 401){
            return refreshTokens(()=>getProducts());
        }

        return response.json();
    })

    .then(data => {
        const container = document.getElementById('list-products');
        container.innerHTML = '';

        if(data == null ){
            console.log("nenhum product cadastred")
            return
        }

        data.forEach(product => {

            const card = `
                <div class="card">
                    <p class="name">${product.name}</p>
                    <p class="description">Description:${product.description}</p>
                    <p class="price">R$ ${product.price.toFixed(2)}</p>
                    <p class="quantity">Quantity: ${product.quantity}</p>
                    <div>
                        <small> ID: ${product.product_id}</small><br>
                        <small> Created in: ${new Date(product.created_at).toLocaleString('pt-BR')}</small><br>
                        <small> Updated in: ${new Date(product.updated_at).toLocaleString('pt-BR')}</small><br>
                        <button class="btn-buy" data-id="${product.product_id}">Buy Product</button>
                    </div>
                </div>
            `

            container.innerHTML += card;
        })

        container.addEventListener("click", (e) =>{
            if(e.target.classList.contains("btn-buy")){
                const bntClickedBuy  = e.target;

                const productId = e.target.getAttribute("data-id");
                const productName = e.target.closest('.card').querySelector('.name').innerText;
                const productPrice = e.target.closest('.card').querySelector('.price').innerText;
                if(!confirm(`tem certeza que deseja comprar o produto ${productName} de valor ${productPrice}`)) return;
                
                bntClickedBuy.disabled = true
                bntClickedBuy.innerText = `Processing...`


                createOrder(productId, productName, bntClickedBuy);
            }
        })
    })

    .catch(error => {
        console.error(error);
    });
}

function createOrder(productId, productName, bntClickedBuy){
    console.log("button buy clicked");
    console.log("product id", productId);
    console.log("user id", currentUserId);

    const data = {
        account_id: currentUserId,
        products_ids: [productId],
    }

    opt = {
        method: "POST",
        headers: {
            'Content-Type':'application/json',
            'access-token': `Bearer ${access_token}`
        },

        body: JSON.stringify(data),
    }

    fetch(BASE_API_ENDPOINT + "/api/orders", opt)
    .then(response =>{
        if (response.status ==401){
            return refreshTokens(()=>createOrder(productId, productName));
        }
        return response.json();
    })
    .then(data =>{
        console.log(data);
        if(data.error){
            window.alert(data.message)
            return;
        }
        window.alert(`product buy ${productName}`)
        Profile();
        getProducts();
        // getOrdersProducts(currentUserId);
    })
    .finally(()=>{
        bntClickedBuy.disabled = false
        bntClickedBuy.innerText = `Buy Product`
    })
};

function getOrdersProducts(accountId){
    opt = {
        method: "GET",
        headers: {
            'Content-Type':'application/json',
            'access-token' :`bearer ${access_token}`,
        }
    }

    fetch(BASE_API_ENDPOINT+ "/api/orders/find/account", opt)
    .then(response =>{
        if(response.status == 401){
            return refreshTokens(()=>getOrdersProducts(accountId) );
        }
 
        return response.json()
    })
    .then(data =>{
        if(data == null) {
            console.log("client 0 orders")
            document.getElementById('orders-list').innerHTML = "<p>client 0 orders</p>";
            return;
        }
        console.log("orders searched")
        document.getElementById('orders-list').innerHTML = ``
        data.forEach(order =>{
            getProductById(order.products_ids[0], order.created_at)
        })
    })
}

function getProductById(productId, orderCreatedAt){
    opt = {
        method: "GET",
        headers: {
            'Content-Type':'application/json',
            'access-token' :`bearer ${access_token}`,
        }
    }

    fetch(BASE_API_ENDPOINT + "/api/product/find/"+ productId, opt)
    .then(response =>{
        if(response.status == 401){
           return refreshTokens(() => getProductById(productId, orderCreatedAt));
        }
        return response.json();
    })
    .then(data =>{
        const ordersList = document.getElementById('orders-list')
        ordersList.innerHTML += ordersList.innerHTML = `
            <div class="order-card" id="order-${data.product_id}">
                <div class="order-details">
                    <h4>${data.name}</h4>
                    <p>${data.description}</p>
                    <div class="order-meta">
                        Buyed in: ${new Date(orderCreatedAt).toLocaleString('pt-BR')}
                    </div>
                </div>
                <div class="order-price">
                    R$ ${data.price.toFixed(2)}
                </div>
            </div>
        `;
        // console.log(`product ${JSON.stringify(data)} buyed at ${orderCreatedAt}`)
    })
}

function updateUser(data){
    opt = {
        method:'PUT',
        headers: {
            'Content-Type':'application/json',
            'access-token': `Bearer ${access_token}`,
        },
        body: JSON.stringify(data),
    }

    fetch("/api/user/update", opt)
    .then(response =>{
        if (response.status == 401){
            return refreshTokens(()=>updateUser(data))
        }

        return response.json()
    })
    .then(data =>{
        if (data.error){
            alert(data.message)
            return;
        }

        alert("user updated succes")
        console.log(data)
        Profile();
    })
    .catch(error =>{
        console.log("error de rede", error.message)
    })
}

function addBalance(amount, infoDiv){
    console.log("add balance function", amount)
    infoDiv.innerHTML = `qr informations ${amount}
    <button id="close-balance-info" class="nav-btn">Close</button>
    `
    document.getElementById("close-balance-info").onclick = (en)=>{
        infoDiv.classList.add("hidden")
    }
}

</script>
</html>